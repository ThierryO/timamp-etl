---
title: "Export bird profile data to a CSV file"
author: "Peter Desmet"
output:
  html_document:
    toc: yes
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r results="hide"}
library(bioRad)
source("vp_to_df.R")
```

## 1. Define export settings

Define your export settings/filters, such as the date range, countries and radars to include and where the bird profile data are stored locally (a file path relative to this script):

```{r}
export_settings <- list()
export_settings[["start_date"]]   <- "2016-10-03"
export_settings[["end_date"]]     <- "2016-10-03"
export_settings[["countries"]]    <- c("se")
export_settings[["radars"]]       <- c("ang")
export_settings[["raw_data_dir"]] <- "../data/se-sample/" # Needs a trailing slash!
```

*TODO: will need to get the file paths radar per radar, since `readvp.list()` will only accept data from one radar at a time.*

## 2. Create a list of data file paths

Build a list of all the file (paths) that meet your extraction criteria:

```{r}
vp.file_paths <- bioRad::retrieve_vp_paths(
  start_date = export_settings$start_date,
  end_date = export_settings$end_date,
  country = export_settings$countries,
  radar = export_settings$radars,
  path = export_settings$raw_data_dir
)
```

The file paths only start at the level of the data directory, so we need to append all with the path to the data directory itself:

```{r}
vp.file_paths <- paste0(export_settings$raw_data_dir, vp.file_paths)
head(vp.file_paths)
```

## 3. Read data

### Single file example

Read a single vp file with bioRad:

```{r}
vp.single <- bioRad::readvp("../data/se-sample/2016/10/03/20/45/seang_vp_20161003T2045Z.h5")
```

Have a look at the structure:

```{r}
summary(vp.single)
```

And the data:

```{r}
head(vp.single$data)
```

Create a data.frame with the data and metadata we need (using the `vp_to_df` function):

```{r}
head(vp_to_df(vp.single))
```

### All files

```{r}
vp.some <- bioRad::readvp.list(c(
  "../data/se-sample/2016/10/03/20/00/seang_vp_20161003T2000Z.h5",
  "../data/se-sample/2016/10/03/20/15/seang_vp_20161003T2015Z.h5",
  "../data/se-sample/2016/10/03/20/30/seang_vp_20161003T2030Z.h5",
  "../data/se-sample/2016/10/03/20/45/seang_vp_20161003T2045Z.h5"
))
vp.all <- bioRad::readvp.list(vp.file_paths)
```
Create a data.frame with the data and metadata we need from all those files:

```{r}
vpdf.list = list()
for (i in seq_along(vp.all)) {
  vpdf.list[[i]] <- vp_to_df(vp.all[[i]])
}

vpdf = dplyr::bind_rows(vpdf.list)
```

```{r}
head(vpdf)
```

## 4. Export data as CSV file

```{r}
write.csv(vpdf, file = "../data/interim/vp.csv", na="")
```
