---
title: "Extract bird profile data to CSV files"
author: "Peter Desmet"
output: html_notebook
---

```{r echo=FALSE}
library(bioRad)
library(tidyr)
```

## 1. Define extraction settings

Define your extraction settings/filters, such as the date range, countries and radars to include and where the bird profile data are stored locally (a file path relative to this script). These settings will overwrite the download settings from [the first script](1_download_vp.Rmd).

```{r}
settings <- list()
settings["start_date"]   <- "2016-10-03"
settings["end_date"]     <- "2016-10-03"
settings["countries"]    <- c("se")
settings["radars"]       <- c("ang")
settings["raw_data_dir"] <- "../data/se-sample/" # Needs a trailing slash!
```

*TODO: will need to get the file paths radar per radar, since `readvp.list()` will only accept data from one radar at a time.*

## 2. Create a list of data file paths

Let's build a list of all the file (paths) that meet your extraction criteria:

```{r}
vp.file_paths <- bioRad::retrieve_vp_paths(
  start_date = settings$start_date,
  end_date = settings$end_date,
  country = settings$countries,
  radar = settings$radars,
  path = settings$raw_data_dir
)
```

The file paths only start at the level of the data directory, so we need to append all with the path to the data directory itself:

```{r}
vp.file_paths <- paste0(settings$raw_data_dir, vp.file_paths)
head(vp.file_paths) # Show 5 first entries
```

## 3. Read data

```{r}
vp.one <- bioRad::readvp("../data/se-sample/2016/10/03/20/45/seang_vp_20161003T2045Z.h5") # A single file
vp.some <- bioRad::readvp.list(c(
  "../data/se-sample/2016/10/03/20/00/seang_vp_20161003T2000Z.h5",
  "../data/se-sample/2016/10/03/20/15/seang_vp_20161003T2015Z.h5",
  "../data/se-sample/2016/10/03/20/30/seang_vp_20161003T2030Z.h5",
  "../data/se-sample/2016/10/03/20/45/seang_vp_20161003T2045Z.h5"
))
vp.all <- bioRad::readvp.list(vp.file_paths)
```

### Fetch method

Returns a list with HGHT as column headers and a single variable as the row. Not that useful:

```{r}
bioRad::fetch(vp.one, quantity = "v")
```

### Data method

Returns a data.frame with variables as column headers and HGHTs as rows. Exactly what I need. ðŸ™Œ

```{r}
vp.one$data
```

