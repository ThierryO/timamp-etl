---
title: "Create timeseries from h5 bird profile data"
author: "Peter Desmet"
output: html_notebook
---

```{r}
library(devtools)
library(rhdf5)
library(bioRad)
```

## 1. Install packages

If you get any missing package errors, install the following packages via the R Studio console:

### rhdf5

```{r eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("rhdf5")
```

### bioRad

Install bioRad from the `vignettes` branch on ENRAM ([until this pull request is accepted](https://github.com/adokter/bioRad/pull/32)):

```{r eval=FALSE}
install_github("enram/bioRad", ref="vignettes")
```

## 2. Define your settings

### Local data directory

Path (relative to this script) where h5 bird profile data are stored locally or where they should be downloaded to:

```{r}
settings.h5_data_dir <- "../data/raw/" # Needs a trailing slash!
```

### Date range

Date range to include (both dates inclusive):

```{r}
settings.start_date = "2017-03-01"
settings.end_date = "2017-04-30"
```

### Countries

List of countries (ISO_3166-1 alpha 2) to include:

```{r}
settings.countries = c("se")
```

### Radars

List of radars (ODIM codes) to include:

```{r}
settings.radars = c("ang", "kkr")
```

## 3. Download bird profile data

_Ignore this step if you already have all the required bird profile data locally._

Download the data you are interested in from the [ENRAM bird profile data repository](http://enram.github.io/data-repository). Note that this step might take some time:

```{r results="hide", eval=FALSE}
bioRad::download_vp(
  localpath = settings.h5_data_dir,
  start_date = settings.start_date,
  end_date = settings.end_date,
  country = settings.countries,
  radar = settings.radars
)
```

_TODO: ideally, the range of radars andshould get input on time window and radars. Example right now is two radars from Sweden for March and April 2017._

## Create timeseries

Create a list of all the paths to the h5 bird profile data files (using the same settings we used to download the data):

```{r}
h5_files.paths <- bioRad::retrieve_vp_paths(
  path = settings.h5_data_dir,
  start_date = settings.start_date,
  end_date = settings.end_date,
  country = settings.countries,
  radar = settings.radars
)
```

The file paths only start at the level of the data directory, so we need to append all with the path to the data directory itself:

```{r}
h5_files.full_paths <- paste0(settings.h5_data_dir, h5_files.paths)
head(h5_files.full_paths)
```

```{r}
# vp <- bioRad::readvp.list(h5_files.full_paths)
vp <- bioRad::readvp("../data/bewid_vp_20151009T0000Z.h5")
```

```{r}
data(vp)
# plot bird profile
plot(vp, line.col = 'blue')
```

